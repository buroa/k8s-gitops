# 1Password ExternalSecrets Setup Guide

This guide covers all the secrets needed for your home-ops Kubernetes cluster.

## üìã Overview

Your cluster uses **19 different 1Password entries** to manage secrets. They're categorized by setup complexity:

## ‚úÖ COMPLETED
- `actions-runner` - GitHub Actions self-hosted runners
- `github-bot` - Repository automation (Renovate, labeling, etc.)

## üî¥ HIGH PRIORITY (Manual Setup Required)

These require external API keys from third-party services:

### 1. Cloudflare (`cloudflare`)
**Purpose**: DNS management, Cloudflare Tunnel, R2 storage
**Setup**: `./scripts/setup-external-apis.sh`
**Manual steps**:
1. Go to https://dash.cloudflare.com/profile/api-tokens
2. Create token with Zone:DNS:Edit permissions
3. Copy token to script

### 2. Tailscale (`tailscale`)
**Purpose**: VPN mesh networking
**Setup**: `./scripts/setup-external-apis.sh`
**Manual steps**:
1. Go to https://login.tailscale.com/admin/settings/keys
2. Generate reusable auth key
3. Copy to script

### 3. UniFi (`unifi`)
**Purpose**: Network monitoring
**Setup**: `./scripts/setup-external-apis.sh`
**Manual steps**:
1. Access UniFi controller
2. Create API user
3. Note URL and credentials

### 4. Alertmanager (`alertmanager`)
**Purpose**: Push notifications
**Setup**: `./scripts/setup-external-apis.sh`
**Manual steps**:
1. Sign up at https://pushover.net/
2. Get User Key and create App for API Token
3. Optional: Set up https://healthchecks.io/ for dead man's switch

### 5. Backup Encryption (`volsync-restic-template`)
**Purpose**: Encrypted backups
**Setup**: `./scripts/setup-backup-encryption.sh`
**This generates a strong encryption passphrase**

## üü° MEDIUM PRIORITY (Set After App Deployment)

These apps generate their own API keys after installation:

### Media Stack
- `radarr` - Movie management
- `sonarr` - TV show management
- `prowlarr` - Indexer management
- `sabnzbd` - Download client
- `autobrr` - Release automation
- `cross-seed` - Cross-seeding

**Setup process**:
1. Deploy the applications
2. Access web UI for each app
3. Go to Settings ‚Üí General ‚Üí API Key
4. Copy API key to 1Password entry

### Monitoring & Tools
- `grafana` - Dashboards (admin password)
- `gatus` - Status monitoring (admin password)
- `atuin` - Shell history (admin password)

**Setup process**:
1. Deploy applications
2. Set admin password during initial setup
3. Store in 1Password

### IoT
- `zigbee2mqtt` - Zigbee device management

**Setup process**:
1. Deploy application
2. Configure MQTT credentials
3. Store in 1Password

## üü¢ LOW PRIORITY (Auto-Generated)

These are automatically generated by Kubernetes:

### Database
- `cloudnative-pg` - PostgreSQL credentials
  - Auto-generated by the CloudNativePG operator
  - No manual setup required

### GitOps
- `flux` - Webhook tokens
  - Can be generated automatically
  - Used for Git repository webhooks

## üîß SPECIAL CASES

### SMTP Relay (`smtp-relay`)
**Purpose**: Email notifications
**Requirements**: Email service credentials (Gmail, SendGrid, etc.)
**Setup**: Manual - depends on your email provider

## üöÄ Quick Start Commands

1. **Set up critical external APIs**:
   ```bash
   ./scripts/setup-external-apis.sh
   ```

2. **Set up backup encryption**:
   ```bash
   ./scripts/setup-backup-encryption.sh
   ```

3. **Deploy your cluster** - then set up medium-priority secrets as apps come online

4. **Verify ExternalSecrets are working**:
   ```bash
   kubectl get externalsecrets -A
   kubectl get secrets -A | grep -v kubernetes.io
   ```

## üìä Status Tracking

Use this checklist to track your progress:

### Critical Infrastructure
- [ ] `cloudflare` - DNS/CDN
- [ ] `tailscale` - VPN
- [ ] `unifi` - Network monitoring
- [ ] `alertmanager` - Notifications
- [ ] `volsync-restic-template` - Backup encryption

### Applications (Deploy First, Then Configure)
- [ ] `radarr` - Movies
- [ ] `sonarr` - TV Shows
- [ ] `prowlarr` - Indexers
- [ ] `sabnzbd` - Downloads
- [ ] `autobrr` - Automation
- [ ] `cross-seed` - Cross-seeding
- [ ] `grafana` - Dashboards
- [ ] `gatus` - Monitoring
- [ ] `atuin` - Shell history
- [ ] `zigbee2mqtt` - IoT

### Optional
- [ ] `smtp-relay` - Email
- [ ] `flux` - Git webhooks

## üîç Troubleshooting

**ExternalSecret not syncing?**
```bash
# Check ExternalSecret status
kubectl describe externalsecret <name> -n <namespace>

# Check 1Password connection
kubectl get clustersecretstore onepassword -o yaml

# Verify secret was created
kubectl get secret <secret-name> -n <namespace>
```

**OnePassword Connect base64 encoding issue?**
**Symptoms**: Sync container error: `"illegal base64 data at input byte 0"` or `"Authentication failed, invalid bearer token"`
**Solution**: This issue has been **permanently fixed** in the bootstrap template.

**Root Cause**: 
1. 1Password Connect sync container requires double base64 encoding (documented in GitHub issue #202)
2. Connect token must match the server that generated the credentials file

**Fix Applied**: Modified `bootstrap/secrets.yaml.tpl` to:
- Apply correct double base64 encoding by pre-encoding credentials once (Kubernetes encodes again)
- Use the "homelab" Connect server (not "homelab-k8s" variants)
- Automatically handle quote escaping in credentials JSON

**Verification**: 
- ClusterSecretStore should show "store validated" status
- ExternalSecrets should sync successfully (30+ working in typical setup)

**If you still encounter issues**:
1. Verify 1Password CLI access: `op signin`
2. Re-run bootstrap: `task bootstrap:apps`  
3. Check ClusterSecretStore: `kubectl get clustersecretstore onepassword`

**Missing 1Password entry?**
```bash
# List all items in vault
op item list --vault homelab

# Check specific item
op item get <item-name> --vault homelab
```
