# 1Password Secret Management

*For users setting up secret management in their home-ops cluster*

## How It Works

Your Kubernetes cluster automatically pulls secrets from your 1Password "homelab" vault using:
- **1Password Connect** - Runs in your cluster to access 1Password
- **ExternalSecrets** - Automatically syncs secrets from 1Password to Kubernetes
- **Task commands** - Automated setup and troubleshooting

## Quick Setup

The cluster handles 1Password Connect automatically. You just need to:

1. **Store secrets in 1Password** - Create items in your "homelab" vault
2. **Run the setup** - `task bootstrap:apps` handles the 1Password connection
3. **Apps get secrets automatically** - No manual intervention needed

## What You Need to Set Up

The cluster automatically handles the 1Password connection, but you need to create these secret items in your "homelab" vault:

## ðŸ”´ REQUIRED (External API Keys)

You must get these from third-party services:

### 1. Cloudflare (`cloudflare`)
**Purpose**: DNS management, Cloudflare Tunnel
**Setup**: `./scripts/setup-external-apis.sh`
**Manual steps**:
1. Go to https://dash.cloudflare.com/profile/api-tokens
2. Create token with Zone:DNS:Edit permissions
3. Copy token to script

### 2. Tailscale (`tailscale`)
**Purpose**: VPN mesh networking
**Setup**: `./scripts/setup-external-apis.sh`
**Manual steps**:
1. Go to https://login.tailscale.com/admin/settings/keys
2. Generate reusable auth key
3. Copy to script

### 3. UniFi (`unifi`)
**Purpose**: Network monitoring
**Setup**: `./scripts/setup-external-apis.sh`
**Manual steps**:
1. Access UniFi controller
2. Create API user
3. Note URL and credentials

### 4. Alertmanager (`alertmanager`)
**Purpose**: Push notifications
**Setup**: `./scripts/setup-external-apis.sh`
**Manual steps**:
1. Sign up at https://pushover.net/
2. Get User Key and create App for API Token
3. Optional: Set up https://healthchecks.io/ for dead man's switch

### 5. Backup Encryption (`volsync-restic-template`)
**Purpose**: Encrypted backups to S3-compatible storage
**Setup**: `./scripts/setup-backup-encryption.sh`
**This generates a strong encryption passphrase**

**Storage Note**: This setup uses SeaweedFS on Synology NAS as S3-compatible storage. You may need to adjust:
- S3 endpoint URLs in your backup configurations
- S3 access credentials for your storage system
- Bucket names to match your setup

## ðŸŸ¡ MEDIUM PRIORITY (Set After App Deployment)

These apps generate their own API keys after installation:

### Media Stack
- `radarr` - Movie management
- `sonarr` - TV show management
- `prowlarr` - Indexer management
- `sabnzbd` - Download client
- `autobrr` - Release automation
- `cross-seed` - Cross-seeding

**Setup process**:
1. Deploy the applications
2. Access web UI for each app
3. Go to Settings â†’ General â†’ API Key
4. Copy API key to 1Password entry

### Monitoring & Tools
- `grafana` - Dashboards (admin password)
- `gatus` - Status monitoring (admin password)
- `atuin` - Shell history (admin password)

**Setup process**:
1. Deploy applications
2. Set admin password during initial setup
3. Store in 1Password

### IoT
- `zigbee2mqtt` - Zigbee device management

**Setup process**:
1. Deploy application
2. Configure MQTT credentials
3. Store in 1Password

## ðŸŸ¢ LOW PRIORITY (Auto-Generated)

These are automatically generated by Kubernetes:

### Database
- `cloudnative-pg` - PostgreSQL credentials
  - Auto-generated by the CloudNativePG operator
  - No manual setup required

### GitOps
- `flux` - Webhook tokens
  - Can be generated automatically
  - Used for Git repository webhooks

## ðŸ”§ SPECIAL CASES

### SMTP Relay (`smtp-relay`)
**Purpose**: Email notifications
**Requirements**: Email service credentials (Gmail, SendGrid, etc.)
**Setup**: Manual - depends on your email provider

## ðŸš€ Quick Start

1. **Set up external API keys** (use the forms above to get API keys from each service)

2. **Store them in 1Password** - Create items with the exact names listed above in your "homelab" vault

3. **Deploy your cluster**:
   ```bash
   task bootstrap:apps
   ```

4. **Verify secrets are syncing**:
   ```bash
   # Check that secrets are syncing from 1Password
   kubectl get externalsecrets -A
   
   # Fix any sync issues automatically  
   task kubernetes:sync-secrets
   ```

5. **Set up app-specific secrets** - After apps are deployed, get their API keys from their web interfaces

## ðŸ“Š Status Tracking

Use this checklist to track your progress:

### Critical Infrastructure
- [ ] `cloudflare` - DNS/CDN
- [ ] `tailscale` - VPN
- [ ] `unifi` - Network monitoring
- [ ] `alertmanager` - Notifications
- [ ] `volsync-restic-template` - Backup encryption

### Applications (Deploy First, Then Configure)
- [ ] `radarr` - Movies
- [ ] `sonarr` - TV Shows
- [ ] `prowlarr` - Indexers
- [ ] `sabnzbd` - Downloads
- [ ] `autobrr` - Automation
- [ ] `cross-seed` - Cross-seeding
- [ ] `grafana` - Dashboards
- [ ] `gatus` - Monitoring
- [ ] `atuin` - Shell history
- [ ] `zigbee2mqtt` - IoT

### Optional
- [ ] `smtp-relay` - Email
- [ ] `flux` - Git webhooks

## Troubleshooting

### Secrets Not Syncing
```bash
# One command fixes most issues automatically
task kubernetes:sync-secrets
```

This command automatically:
- Checks if 1Password Connect is working
- Recreates the connection if broken  
- Forces all secrets to sync from 1Password

### Check What's Working
```bash
# See all secret sync status
kubectl get externalsecrets -A

# Check specific secret details
kubectl describe externalsecret <name> -n <namespace>
```

### Missing 1Password Items
```bash
# List all items in your vault
op item list --vault homelab

# Create a new secret (example)
op item create --vault homelab --title "app-name" password=<api-key>
```

The 1Password Connect authentication is fully automated - if you have issues, `task kubernetes:sync-secrets` will fix them.
