---
version: "3"

vars:
  alertmanagerDomain: https://am.ktwo.io
  alertmanagerSilencesDir: '{{.ROOT_DIR}}/.taskfiles/Alertmanager/silences'

tasks:

  apply-silences:
    desc: Apply all silences
    cmds:
      - for: { var: silences, split: '' }
        task: silence
        vars:
          silence: '{{.ITEM}}'
    vars:
      silences:
        sh: find "{{.alertmanagerSilencesDir}}" -type f -name "*.json" -print

  silence:
    desc: Apply a silence file
    summary: |
      Args:
        silence: Silence file to apply (required)
    requires:
      vars: ["silence"]
    cmd: |-
      curl -H "Content-Type: application/json" -d @{{.silence}} {{.alertmanagerDomain}}/api/v2/silences
    preconditions:
      - { msg: "Silence file not found", sh: "test -f {{.silence}}" }

  remove-silences:
    desc: Remove all silences
    cmds:
      - for: { var: silences, split: '' }
        task: unsilence
        vars:
          silence: '{{.ITEM}}'
    vars:
      silences:
        sh: |
          curl -s "{{.alertmanagerDomain}}/api/v2/silences?silenced=false&inhibited=false&active=true" | jq -r '.[] | .id'

  unsilence:
    desc: Remove a silence
    summary: |
      Args:
        silence: Silence ID to remove (required)
    cmd: curl -s -X DELETE {{.alertmanagerDomain}}/api/v2/silence/{{.silence}}
    requires:
      vars: ["silence"]
    preconditions:
      - { msg: "Silence not found", sh: "curl -s {{.alertmanagerDomain}}/api/v2/silence/{{.silence}}" }
