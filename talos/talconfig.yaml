---
clusterName: &cluster k8s
clusterPodNets: ["10.244.0.0/16"]
clusterSvcNets: ["10.245.0.0/16"]
additionalApiServerCertSans: ["127.0.0.1"]
additionalMachineCertSans: ["127.0.0.1"]
endpoint: https://k8s.internal:6443
kubernetesVersion: ${KUBERNETES_VERSION}
talosVersion: ${TALOS_VERSION}

nodes:
  - hostname: m0.k8s.internal
    ipAddress: 192.168.10.10
    controlPlane: true
    installDiskSelector:
      serial: S666NN0W402512
    machineDisks:
      - device: /dev/disk/by-id/nvme-SAMSUNG_MZ1L21T9HCLS-00A07_S666NG0X101174
        partitions:
          - mountpoint: /var/mnt/extra
    networkInterfaces:
      - &bond0
        interface: bond0
        bond:
          mode: 802.3ad
          xmitHashPolicy: layer3+4
          lacpRate: fast
          miimon: 1000
          deviceSelectors: [{ hardwareAddr: "58:47:ca:77:*", driver: i40e }]
        dhcp: true
        mtu: 9000
        vlans:
          - { vlanId: 20, dhcp: false, mtu: 1500 }
          - { vlanId: 30, dhcp: false, mtu: 1500 }
      - deviceSelector:
          busPath: 1-1.0 # m1
        dhcp: false
        mtu: 65520
        addresses: ["169.254.255.10/32"]
        routes: [{ network: "169.254.255.11/32", metric: 2048 }]
      - deviceSelector:
          busPath: 0-1.0 # m2
        dhcp: false
        mtu: 65520
        addresses: ["169.254.255.10/32"]
        routes: [{ network: "169.254.255.12/32", metric: 2048 }]

  - hostname: m1.k8s.internal
    ipAddress: 192.168.10.11
    controlPlane: true
    installDiskSelector:
      serial: S666NG0X101148
    machineDisks:
      - device: /dev/disk/by-id/nvme-SAMSUNG_MZ1L21T9HCLS-00A07_S666NN0W110861
        partitions:
          - mountpoint: /var/mnt/extra
    networkInterfaces:
      - <<: *bond0
      - deviceSelector:
          busPath: 0-1.0 # m0
        dhcp: false
        mtu: 65520
        addresses: ["169.254.255.11/32"]
        routes: [{ network: "169.254.255.10/32", metric: 2048 }]
      - deviceSelector:
          busPath: 1-1.0 # m2
        dhcp: false
        mtu: 65520
        addresses: ["169.254.255.11/32"]
        routes: [{ network: "169.254.255.12/32", metric: 2048 }]

  - hostname: m2.k8s.internal
    ipAddress: 192.168.10.12
    controlPlane: true
    installDiskSelector:
      serial: S666NN0W401713
    machineDisks:
      - device: /dev/disk/by-id/nvme-SAMSUNG_MZ1L21T9HCLS-00A07_S666NN0X221313
        partitions:
          - mountpoint: /var/mnt/extra
    networkInterfaces:
      - <<: *bond0
      - deviceSelector:
          busPath: 0-1.0 # m0
        dhcp: false
        mtu: 65520
        addresses: ["169.254.255.12/32"]
        routes: [{ network: "169.254.255.10/32", metric: 2048 }]
      - deviceSelector:
          busPath: 1-1.0 # m1
        dhcp: false
        mtu: 65520
        addresses: ["169.254.255.12/32"]
        routes: [{ network: "169.254.255.11/32", metric: 2048 }]

controlPlane:
  noSchematicValidate: true

  schematic:
    customization:
      extraKernelArgs:
        - apparmor=0              # Less security, faster puter
        - init_on_alloc=0         # Less security, faster puter
        - init_on_free=0          # Less security, faster puter
        - intel_iommu=on          # PCI Passthrough
        - iommu=pt                # PCI Passthrough
        - mitigations=off         # Less security, faster puter
        - security=none           # Less security, faster puter
        - talos.auditd.disabled=1 # Less security, faster puter

      systemExtensions:
        officialExtensions:
          - siderolabs/gasket-driver
          - siderolabs/i915
          - siderolabs/intel-ucode
          - siderolabs/mei
          - siderolabs/thunderbolt

  machineSpec:
    secureboot: true

  nodeLabels:
    topology.kubernetes.io/region: *cluster
    topology.kubernetes.io/zone: m

  patches:
    - "@./patches/cluster.yaml"
    - "@./patches/machine.yaml"
    - |-
      - op: remove
        path: /cluster/apiServer/admissionControl
    - |-
      - op: remove
        path: /cluster/apiServer/auditPolicy
