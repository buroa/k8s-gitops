---
apiVersion: v1
kind: Secret
metadata:
  name: vaultwarden-restic-secret
  namespace: home
type: Opaque
stringData:
  RESTIC_REPOSITORY: s3:https://${SECRET_S3_GATEWAY_SERVICE_ENDPOINT}/${SECRET_PUBLIC_DOMAIN}/backups/vaultwarden
  RESTIC_PASSWORD: ${SECRET_RESTIC_PASSWORD}
  AWS_ACCESS_KEY_ID: ${SECRET_S3_GATEWAY_ACCESS_KEY}
  AWS_SECRET_ACCESS_KEY: ${SECRET_S3_GATEWAY_SECRET_KEY}
---
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: vaultwarden
  namespace: home
spec:
  sourcePVC: vaultwarden-config
  trigger:
    schedule: "0 0 * * *"
  restic:
    copyMethod: Snapshot
    pruneIntervalDays: 10
    repository: vaultwarden-restic-secret
    cacheCapacity: 5Gi
    volumeSnapshotClassName: ${CLUSTER_SNAPSHOT_CLASS}
    storageClassName: ${CLUSTER_STORAGE_CLASS}
    moverSecurityContext:
      runAsUser: 568
      runAsGroup: 568
      fsGroup: 568
    retain:
      daily: 10
      within: 3d
